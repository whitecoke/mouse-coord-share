<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>mouse move console log</title>
    </head>

    <body>
        <div id="coord">coordinations</div>
        <div id="user">userName</div>
        <div id="users"></div>
        <script>
            function changeCoordString(x, y) {
                document.getElementById("coord").innerHTML = `x: ${x}, y: ${y}`;
              };
              
            function changeUserName() {
                const query = new URLSearchParams(window.location.search);
                const userName = query.get("name");
                if (userName === null) document.getElementById("user").innerHTML = "undefined";
                else                   document.getElementById("user").innerHTML = userName;
            }
                
            async function mousemove(event) {
                const x = event.pageX;
                const y = event.pageY;
                changeCoordString(x, y);
                
                const userName = document.getElementById("user").innerHTML;
                if (userName === null) throw "";
                await fetch(`http://localhost:8000/coord?name=${userName}&x=${x}&y=${y}`, {
                    method: "put"
                });
            };
            
            window.addEventListener('mousemove', mousemove);
            window.onload = changeUserName();

            setInterval(async () => {
                const curUserName = document.getElementById("user").innerHTML;
                const res = await fetch("http://localhost:8000/coord");
                const users = await res.json();
                for (const user of users) {
                    if (user.userName === curUserName) continue;
                    const userDiv = document.getElementById(user.userName);
                    if (!userDiv) {
                        const div = document.createElement("div");
                        div.id        = user.userName;
                        div.innerHTML = `
                            <img src="https://cdn-icons-png.flaticon.com/512/889/889817.png" width="30px" height="30px" />
                            ${user.userName}
                        `;
                        div.style.position = "absolute";
                        div.style.left = `${user.coordinations[0]}px`;
                        div.style.top  = `${user.coordinations[1]}px`;
                        document.querySelector("#users").appendChild(div);
                    } else {
                        userDiv.style.left = `${user.coordinations[0]}px`;
                        userDiv.style.top  = `${user.coordinations[1]}px`;
                    }
                }
            }, 50);
        </script>
    </body>
</html>
